{{ define "gen_primitive" }}
    gen{{ .GetGenFuncName }} := func(data {{ .Name }}) {{ .GetWrapperName true }} {
        return {{ .WrapToProtoType "data" }}
    }
{{ end }}

{{ define "gen_wrapped_primitive" }}
    gen{{ .GetGenFuncName }} := func(data {{ .GetParamTypeName "" }}) {{ .GetWrapperName true }} {
        if data == nil {
            return nil
        }

        return {{ .GetWrapperName false }}{
            Value: {{ .WrapToProtoType "*data" }},
        }
    }
{{ end }}

{{ define "gen_struct" }}
    {{- $UpperCaseName := .Name.ToUpperCamelCase -}}
    {{- $Package := "client" -}}
    {{ $ProtoPackageName := "proto_client" -}}

    gen{{ $UpperCaseName }} := func(data {{ .GetParamTypeName $Package }}) {{ .GetReturnTypeName $ProtoPackageName true }} {
        res := {{ .GetReturnTypeName $ProtoPackageName false }}{
        {{ range $item := .Struct.Fields }}
            {{- if $item.IsExported -}}
            {{ $item.GetUpperCamelCaseName "" "" }}: gen{{ .Type.GetGenFuncName }}(data.{{ $item.Name }}),
            {{ end -}}
        {{ end }}
        }

        return res
    }
{{ end }}

{{ define "gen_slice" }}
    {{- $Package := "client" -}}
    {{- $ProtoPackageName := "proto_client" -}}

    gen{{ .GetGenFuncName }} := func(data {{ .GetParamTypeName $Package }}) {{ .GetReturnTypeName $ProtoPackageName true }} {
        res := make({{ .GetReturnTypeName $ProtoPackageName true }}, 0, len(data))

        for _, v := range data {
            {{ if .Slice.InnerType.Pointer -}}
            if v == nil {
                res = append(res, nil)
                continue
            }
            {{ end -}}
            d := gen{{ .Slice.InnerType.GetGenFuncName }}(v)
            res = append(res, d)
        }

        return res
    }
{{ end }}

{{ define "gen_pointer" }}
    {{- $Package := "client" -}}
    {{- $ProtoPackageName := "proto_client" -}}

    gen{{ .GetGenFuncName }} := func(data {{ .GetParamTypeName $Package }}) {{ .GetReturnTypeName $ProtoPackageName true }} {
        if data == nil {
            return nil
        }

        res := gen{{ .Pointer.InnerType.GetGenFuncName }}(*data)
        return res
    }
{{ end }}

{{- if .Function.IsSubscription }}
func {{ .Function.FunctionName }}(argsBytes []byte, callback goapi.EventCallback) (goapi.Subscription, error) {
    args := {{ .CodeList.PackageMap.ProtoPackageName }}.{{ .Function.FunctionName }}Args{}

    if err := proto.Unmarshal(argsBytes, &args); err != nil {
        return nil, err
    }

    return {{ .Package }}.{{ .Function.FunctionName }}({{ range $item := .Function.Args }}{{ $item.GetUpperCamelCaseName "args." "go" }}, {{ end }}func(data {{ .GetEventTypeName }}) {
        {{ range $i, $item := .FlatFields -}}
            //{{ $i }}
            {{ if $item.IsPrimitive -}}
            {{- template "gen_primitive" $item -}}
            {{- else if $item.IsPrimitivePointer -}}
            {{- template "gen_wrapped_primitive" $item -}}
            {{- else if $item.Struct -}}
            {{- template "gen_struct" $item -}}
            {{- else if $item.Slice -}}
            {{- template "gen_slice" $item -}}
            {{- else if $item.Pointer -}}
            {{- template "gen_pointer" $item -}}
            {{- end -}}
        {{- end -}}

        bytes, err := proto.Marshal(gen{{ .GetLastFunction.GetGenFuncName }}(data))
        if err == nil {
            callback.OnEvent(bytes)
        }
    })
}
{{ end }}